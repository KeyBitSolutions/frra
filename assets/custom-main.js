class v extends HTMLElement{constructor(){super(),this.variantChangeUnsubscriber=null,this.optionChangeUnsubscriber=null}connectedCallback(){this.setupVariantChangeListener()}disconnectedCallback(){this.variantChangeUnsubscriber&&(this.variantChangeUnsubscriber(),this.variantChangeUnsubscriber=null),this.optionChangeUnsubscriber&&(this.optionChangeUnsubscriber(),this.optionChangeUnsubscriber=null)}setupVariantChangeListener(){var t,e,r,n;(e=(t=window.theme)==null?void 0:t.PUB_SUB_EVENTS)!=null&&e.variantChange&&window.subscribe&&(this.variantChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.variantChange,this.handleVariantChange.bind(this))),(n=(r=window.theme)==null?void 0:r.PUB_SUB_EVENTS)!=null&&n.optionValueSelectionChange&&window.subscribe&&(this.optionChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.optionValueSelectionChange,()=>{setTimeout(()=>this.updateVariantTitle(),200)})),setTimeout(()=>this.updateVariantTitle(),100)}handleVariantChange(t){var e;(e=t==null?void 0:t.detail)!=null&&e.variant?this.updateVariantTitleFromVariant(t.detail.variant):this.updateVariantTitle()}updateVariantTitle(){const t=document.querySelector("variant-selects");let e=null;if(t&&(e=t.querySelector("[data-selected-variant]")),!e){const r=document.querySelector("product-form");r&&(e=r.querySelector("[data-selected-variant]"))}e&&this.parseAndUpdateVariant(e)}parseAndUpdateVariant(t){try{const e=JSON.parse(t.textContent);e&&e.title&&this.updateVariantTitleFromVariant(e)}catch(e){console.warn("Failed to parse variant data:",e)}}updateVariantTitleFromVariant(t){const e=t.title||"";document.querySelectorAll('#pattern_product, input[name="pattern_needles"], input[name="pattern_needles[]"]').forEach(n=>{n.setAttribute("data-current-variant-title",e),this.updatePatternProductCount(n),n.checked&&n.dispatchEvent(new Event("change",{bubbles:!0}))})}updatePatternProductCount(t){const e=t.dataset.additionalProductCountForVariant;if(!e)return;const r=t.dataset.currentVariantTitle||"";let n=1;try{const i=JSON.parse(e);i&&r&&i[r]&&(n=parseInt(i[r],10)||1)}catch(i){console.warn("Failed to parse size count data:",i);return}const a=t.closest("label");if(a){const i=a.querySelector("[data-additional-product-count]");i&&(i.textContent=n)}}}class k extends HTMLElement{constructor(){super(),this.checkboxes=new Map,this.patternProductCheckbox=null,this.currentVariantPrice=0}connectedCallback(){this.init()}disconnectedCallback(){this.removeEventListeners()}init(){if(this.updateCurrentVariantPrice(),this.patternProductCheckbox=this.querySelector("#pattern_product"),!this.patternProductCheckbox){const r=document.querySelectorAll("product-form-checkboxes");for(const n of r){const a=n.querySelector("#pattern_product");if(a){this.patternProductCheckbox=a;break}}}this.patternProductCheckbox&&(this.setupPatternProductCheckbox(),this.updateInitialCount());let t=Array.from(this.querySelectorAll('input[name="pattern_needles"], input[name="pattern_needles[]"]'));const e=document.querySelectorAll("product-form-checkboxes");for(const r of e)if(r!==this){const n=r.querySelectorAll('input[name="pattern_needles"], input[name="pattern_needles[]"]');t=t.concat(Array.from(n))}this.patternNeedleCheckboxes=t.length>0?t:null,this.patternNeedleCheckboxes&&this.patternNeedleCheckboxes.length>0&&this.setupPatternNeedleCheckboxes(),this.setupGenericCheckboxListeners(),this.setupFormSubmit(),this.setupVariantPriceListener()}setupVariantPriceListener(){var t,e,r,n;(e=(t=window.theme)==null?void 0:t.PUB_SUB_EVENTS)!=null&&e.variantChange&&window.subscribe&&(this.variantChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.variantChange,()=>{this.updateCurrentVariantPrice(),this.recalculateTotalPrice()})),(n=(r=window.theme)==null?void 0:r.PUB_SUB_EVENTS)!=null&&n.optionValueSelectionChange&&window.subscribe&&(this.optionChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.optionValueSelectionChange,()=>{setTimeout(()=>{this.updateCurrentVariantPrice(),this.recalculateTotalPrice()},200)}))}updateCurrentVariantPrice(){const t=document.querySelector("variant-selects");let e=null;if(t&&(e=t.querySelector("[data-selected-variant]")),!e){const r=document.querySelector("product-form");r&&(e=r.querySelector("[data-selected-variant]"))}if(e)try{const r=JSON.parse(e.textContent);r&&r.price&&(this.currentVariantPrice=parseInt(r.price,10)||0)}catch(r){console.warn("Failed to parse variant price:",r),this.patternProductCheckbox&&(this.currentVariantPrice=parseFloat(this.patternProductCheckbox.dataset.mainProductPrice||0))}else this.patternProductCheckbox&&(this.currentVariantPrice=parseFloat(this.patternProductCheckbox.dataset.mainProductPrice||0))}setupFormSubmit(){const t=this.closest("form")||document.querySelector('form[action*="/cart/add"]');t&&(this.form=t,this.boundHandleFormSubmit=this.handleFormSubmit.bind(this),t.addEventListener("submit",this.boundHandleFormSubmit,!0))}handleFormSubmit(t){var P,S,w,g;const e=this.patternProductCheckbox&&this.patternProductCheckbox.checked,r=Array.from(this.patternNeedleCheckboxes||[]).some(c=>c.checked);if(!e&&!r)return;t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const n=t.target,a=n.querySelector('[type="submit"]');a&&(a.disabled=!0,a.classList.add("loading"));const i=n.querySelector('input[name="section-id"]'),o=i?i.value:null,d=n.querySelector('input[name="id"]'),s=n.querySelector('input[name="quantity"]');if(!d){console.error("Variant ID not found"),this.enableSubmitButton(a);return}const l=parseInt(d.value,10),V=s&&parseInt(s.value,10)||1,h=[];if(this.patternNeedleCheckboxes&&this.patternNeedleCheckboxes.length>0&&Array.from(this.patternNeedleCheckboxes).forEach(c=>{if(c.checked){const u=this.buildPatternProductItem(c);u?(h.push(u),console.log("Added needle product to cart items:",u)):console.warn("Failed to build item for needle checkbox:",c)}}),this.patternProductCheckbox&&this.patternProductCheckbox.checked){const c=this.buildPatternProductItem(this.patternProductCheckbox);if(c)h.push(c);else{this.enableSubmitButton(a),this.handleAddToCartError(new Error("Pattern product variant not available. Please try again."));return}}if(h.push({id:l,quantity:V}),!h||h.length===0){console.error("No items to add to cart"),this.enableSubmitButton(a);return}const f=h.filter(c=>!c.id||isNaN(c.id)||c.quantity<=0);if(f.length>0){console.error("Invalid items:",f),this.enableSubmitButton(a);return}const b={items:h};o?b.sections_url=`/cart?section_id=cart-drawer&section_id=${encodeURIComponent(o)}`:b.sections_url="/cart?section_id=cart-drawer";const m=((S=(P=window.theme)==null?void 0:P.routes)==null?void 0:S.root)||((g=(w=window.theme)==null?void 0:w.routes)==null?void 0:g.shop_url)||"/",E=`${m.endsWith("/")?m:`${m}/`}cart/add.js`;fetch(E,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(b)}).then(c=>c.json().then(u=>{if(!c.ok){const x=u.description||u.message||u.error||"Failed to add to cart",C=new Error(x);throw C.response=u,C.status=c.status,C}return u})).then(c=>{this.handleAddToCartSuccess(c,b)}).catch(c=>{console.error("Error adding to cart:",c),this.handleAddToCartError(c)}).finally(()=>{this.enableSubmitButton(a)})}handleAddToCartSuccess(t,e){const r=document.querySelector("cart-element");r&&typeof r.getCart=="function"?r.getCart():(document.dispatchEvent(new CustomEvent("theme:cart:refresh",{bubbles:!0})),t.sections?this.updateCartSections(t.sections):e.sections_url&&this.fetchCartSections(e.sections_url)),document.dispatchEvent(new CustomEvent("theme:cart:add",{detail:{items:t.items||[],cart:t},bubbles:!0}))}handleAddToCartError(t){var r;const e=(r=this.form)==null?void 0:r.querySelector("[data-cart-errors-container]");e&&(e.textContent=t.message||"Failed to add product to cart",e.setAttribute("role","alert"),e.classList.remove("hidden")),document.dispatchEvent(new CustomEvent("theme:cart:add:error",{detail:{error:t},bubbles:!0}))}updateCartSections(t){if(t["cart-drawer"]){const e=document.querySelector("cart-drawer");e&&(e.innerHTML=t["cart-drawer"])}if(t["cart-icon-bubble"]){const e=document.querySelector("[data-cart-icon-bubble]");e&&(e.outerHTML=t["cart-icon-bubble"])}}fetchCartSections(t){fetch(t).then(e=>e.text()).then(e=>{const n=new DOMParser().parseFromString(e,"text/html"),a=n.querySelector("cart-drawer");if(a){const o=document.querySelector("cart-drawer");o&&(o.innerHTML=a.innerHTML)}const i=n.querySelector("[data-cart-icon-bubble]");if(i){const o=document.querySelector("[data-cart-icon-bubble]");o&&(o.outerHTML=i.outerHTML)}}).catch(e=>{console.error("Error fetching cart sections:",e)})}enableSubmitButton(t){t&&(t.disabled=!1,t.classList.remove("loading"))}updateInitialCount(){this.patternProductCheckbox&&this.updateInitialCountForCheckbox(this.patternProductCheckbox)}updateInitialCountForCheckbox(t){if(!t)return;const e=t.dataset.additionalProductCountForVariant;if(!e)return;const r=t.dataset.currentVariantTitle||"";let n=1;try{const i=JSON.parse(e);i&&r&&i[r]&&(n=parseInt(i[r],10)||1)}catch(i){console.warn("Failed to parse size count data:",i);return}if(t.closest("product-form-checkboxes")){const i=t.closest("label");if(i){const o=i.querySelector("[data-additional-product-count]");o&&(o.textContent=n)}}}setupPatternProductCheckbox(){this.patternProductCheckbox.addEventListener("change",t=>{this.handlePatternProductChange(t)}),this.checkboxes.set("pattern_product",this.patternProductCheckbox)}setupPatternNeedleCheckboxes(){this.patternNeedleCheckboxes.forEach(t=>{t.addEventListener("change",r=>{this.handlePatternProductChange(r)});const e=t.id||t.name||`pattern_needle_${this.checkboxes.size}`;this.checkboxes.set(e,t),this.updateInitialCountForCheckbox(t)})}handlePatternProductChange(t){const e=t.target,r=e.checked;this.recalculateTotalPrice(),this.updateInitialCountForCheckbox(e);const n=parseFloat(e.dataset.additionalProductPrice||0),a=e.dataset.additionalProductId,i=e.dataset.additionalProductFormattedPrice||"",o=e.dataset.currentVariantTitle||"",d=e.dataset.additionalProductCountForVariant;let s=1;if(d)try{const l=JSON.parse(d);l&&o&&l[o]&&(s=parseInt(l[o],10)||1)}catch(l){console.warn("Failed to parse size count data:",l)}this.updateCurrentVariantPrice(),this.dispatchPatternProductChangeEvent({isChecked:r,mainProductPrice:this.currentVariantPrice,patternProductPrice:n*s,patternProductPriceBase:n,countMultiplier:s,totalPrice:this.getCalculatedTotalPrice(),patternProductId:a,formattedPrice:i,currentVariantTitle:o}),this.updateFormData(r,a)}recalculateTotalPrice(){var n;this.updateCurrentVariantPrice();const t=this.currentVariantPrice;let e=0;if((n=this.patternProductCheckbox)!=null&&n.checked){const a=this.getCheckboxPrice(this.patternProductCheckbox);e+=a}this.patternNeedleCheckboxes&&this.patternNeedleCheckboxes.length>0&&Array.from(this.patternNeedleCheckboxes).forEach(a=>{if(a.checked){const i=this.getCheckboxPrice(a);e+=i}});const r=t+e;this.updatePriceDisplay(r,e>0,"")}getCheckboxPrice(t){const e=parseFloat(t.dataset.additionalProductPrice||0),r=t.dataset.additionalProductCountForVariant;let n=1;if(r){const a=t.dataset.currentVariantTitle||"";try{const i=JSON.parse(r);i&&a&&i[a]&&(n=parseInt(i[a],10)||1)}catch(i){console.warn("Failed to parse size count data:",i)}}return e*n}getCalculatedTotalPrice(){var r;this.updateCurrentVariantPrice();const t=this.currentVariantPrice;let e=0;return(r=this.patternProductCheckbox)!=null&&r.checked&&(e+=this.getCheckboxPrice(this.patternProductCheckbox)),this.patternNeedleCheckboxes&&this.patternNeedleCheckboxes.length>0&&Array.from(this.patternNeedleCheckboxes).forEach(n=>{n.checked&&(e+=this.getCheckboxPrice(n))}),t+e}dispatchPatternProductChangeEvent(t){const e=new CustomEvent("product:pattern:change",{detail:t,bubbles:!0,cancelable:!0});this.dispatchEvent(e),document.dispatchEvent(e)}updatePriceDisplay(t,e,r){const n=this.formatPrice(t);if(!n){console.warn("Could not format price:",t);return}let a=document.querySelectorAll("[data-add-to-cart] [data-product-price]");if(a.length===0){const i=document.querySelector("[data-add-to-cart]");if(i){const o=i.querySelector("[data-product-price]");o&&(a=[o])}}a.length===0&&(a=document.querySelectorAll("[data-add-to-cart] .product__price--regular")),a.length>0?a.forEach(i=>{i.textContent=n,e?i.classList.add("price--with-pattern-product"):i.classList.remove("price--with-pattern-product")}):console.warn("Price element not found. Selectors tried:",["[data-add-to-cart] [data-product-price]","[data-add-to-cart] .product__price--regular"])}formatPrice(t){var r,n,a,i;return window.Shopify&&window.Shopify.formatMoney?window.Shopify.formatMoney(t,((r=window.theme)==null?void 0:r.moneyFormat)||((n=window.theme)==null?void 0:n.moneyWithCurrencyFormat)):window.theme&&window.theme.formatMoney?window.theme.formatMoney(t,((a=window.theme)==null?void 0:a.moneyFormat)||((i=window.theme)==null?void 0:i.moneyWithCurrencyFormat)):`$${(t/100).toFixed(2)}`}updateFormData(t,e){const r=this.closest("form")||document.querySelector('form[action*="/cart/add"]');if(!r)return;let n=r.querySelector('[name="pattern_product_id"]');t&&e?(n||(n=document.createElement("input"),n.type="hidden",n.name="pattern_product_id",r.appendChild(n)),n.value=e):n&&n.remove()}buildPatternProductItem(t){const e=t.dataset.additionalProductVariantId,r=t.dataset.currentVariantTitle||"",n=t.dataset.additionalProductCountForVariant;let a=1;if(n)try{const i=JSON.parse(n);i&&r&&i[r]&&(a=parseInt(i[r],10)||1)}catch(i){console.warn("Failed to parse size count data:",i)}if(e){const i=parseInt(e,10);return isNaN(i)?(console.error("Invalid additional product variant ID:",e),null):{id:i,quantity:a}}else return console.error("Additional product variant ID not found"),null}setupGenericCheckboxListeners(){this.querySelectorAll('input[type="checkbox"]').forEach(e=>{if(e.id==="pattern_product"||e.name==="pattern_needles"||e.name==="pattern_needles[]")return;e.addEventListener("change",n=>{this.handleGenericCheckboxChange(n)});const r=e.name||e.id||`checkbox-${this.checkboxes.size}`;this.checkboxes.set(r,e)})}handleGenericCheckboxChange(t){const e=t.target,r=e.checked,n=e.name||e.id,a=new CustomEvent("product:checkbox:change",{detail:{name:n,isChecked:r,value:e.value,checkbox:e},bubbles:!0,cancelable:!0});this.dispatchEvent(a),document.dispatchEvent(a)}removeEventListeners(){this.form&&this.boundHandleFormSubmit&&this.form.removeEventListener("submit",this.boundHandleFormSubmit),this.variantChangeUnsubscriber&&(this.variantChangeUnsubscriber(),this.variantChangeUnsubscriber=null),this.optionChangeUnsubscriber&&(this.optionChangeUnsubscriber(),this.optionChangeUnsubscriber=null),this.checkboxes.forEach(t=>{var r;const e=t.cloneNode(!0);(r=t.parentNode)==null||r.replaceChild(e,t)}),this.checkboxes.clear(),this.patternProductCheckbox=null,this.form=null,this.boundHandleFormSubmit=null}getCheckboxState(t){const e=this.checkboxes.get(t)||this.querySelector(`#${t}, [name="${t}"]`);return e?e.checked:null}setCheckboxState(t,e){const r=this.checkboxes.get(t)||this.querySelector(`#${t}, [name="${t}"]`);r&&(r.checked=e,r.dispatchEvent(new Event("change",{bubbles:!0})))}}customElements.get("product-form-checkboxes")||customElements.define("product-form-checkboxes",k);customElements.get("variant-change-listener")||customElements.define("variant-change-listener",v);function y(){const p=setInterval(()=>{const t=customElements.get("variant-selects");if(t){clearInterval(p);const e=t.prototype.connectedCallback,r=t.prototype.disconnectedCallback;t.prototype.connectedCallback=function(){e&&e.call(this),this.setupVariantTitleUpdate()},t.prototype.disconnectedCallback=function(){this.variantTitleUpdateUnsubscriber&&(this.variantTitleUpdateUnsubscriber(),this.variantTitleUpdateUnsubscriber=null),this.optionChangeUnsubscriber&&(this.optionChangeUnsubscriber(),this.optionChangeUnsubscriber=null),r&&r.call(this)},t.prototype.setupVariantTitleUpdate=function(){var n,a;(a=(n=window.theme)==null?void 0:n.PUB_SUB_EVENTS)!=null&&a.optionValueSelectionChange&&window.subscribe&&(this.optionChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.optionValueSelectionChange,()=>{setTimeout(()=>this.updateVariantTitle(),200)})),setTimeout(()=>this.updateVariantTitle(),100)},t.prototype.updateVariantTitle=function(){const n=this.querySelector("[data-selected-variant]");if(n)try{const a=JSON.parse(n.textContent);if(a&&a.title){const i=a.title||"";document.querySelectorAll('#pattern_product, input[name="pattern_needles"], input[name="pattern_needles[]"]').forEach(d=>{d.setAttribute("data-current-variant-title",i),this.updatePatternProductCount(d),d.checked&&d.dispatchEvent(new Event("change",{bubbles:!0}))})}}catch(a){console.warn("Failed to parse variant data:",a)}},t.prototype.updatePatternProductCount=function(n){const a=n.dataset.additionalProductCountForVariant;if(!a)return;const i=n.dataset.currentVariantTitle||"";let o=1;try{const s=JSON.parse(a);s&&i&&s[i]&&(o=parseInt(s[i],10)||1)}catch(s){console.warn("Failed to parse size count data:",s);return}const d=n.closest("label");if(d){const s=d.querySelector("[data-additional-product-count]");s&&(s.textContent=o)}}}},100);setTimeout(()=>clearInterval(p),5e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();typeof window<"u"&&(window.PatternProductForm=k,window.VariantChangeListener=v);
