class E extends HTMLElement{constructor(){super(),this.variantChangeUnsubscriber=null,this.optionChangeUnsubscriber=null}connectedCallback(){this.setupVariantChangeListener()}disconnectedCallback(){this.variantChangeUnsubscriber&&(this.variantChangeUnsubscriber(),this.variantChangeUnsubscriber=null),this.optionChangeUnsubscriber&&(this.optionChangeUnsubscriber(),this.optionChangeUnsubscriber=null)}setupVariantChangeListener(){var e,t,n,r;(t=(e=window.theme)==null?void 0:e.PUB_SUB_EVENTS)!=null&&t.variantChange&&window.subscribe&&(this.variantChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.variantChange,this.handleVariantChange.bind(this))),(r=(n=window.theme)==null?void 0:n.PUB_SUB_EVENTS)!=null&&r.optionValueSelectionChange&&window.subscribe&&(this.optionChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.optionValueSelectionChange,()=>{setTimeout(()=>this.updateVariantTitle(),200)})),setTimeout(()=>this.updateVariantTitle(),100)}handleVariantChange(e){var t;(t=e==null?void 0:e.detail)!=null&&t.variant?this.updateVariantTitleFromVariant(e.detail.variant):this.updateVariantTitle()}updateVariantTitle(){const e=document.querySelector("variant-selects");let t=null;if(e&&(t=e.querySelector("[data-selected-variant]")),!t){const n=document.querySelector("product-form");n&&(t=n.querySelector("[data-selected-variant]"))}t&&this.parseAndUpdateVariant(t)}parseAndUpdateVariant(e){try{const t=JSON.parse(e.textContent);t&&t.title&&this.updateVariantTitleFromVariant(t)}catch(t){console.warn("Failed to parse variant data:",t)}}updateVariantTitleFromVariant(e){const t=e.title||"",n=document.querySelector("#pattern_product");n&&(n.setAttribute("data-current-variant-title",t),this.updatePatternProductCount(n),n.checked&&n.dispatchEvent(new Event("change",{bubbles:!0})))}updatePatternProductCount(e){const t=e.dataset.currentVariantTitle||"",n=e.dataset.parrentProductCountForVariant||"{}";let r=1;try{const o=JSON.parse(n);o&&t&&o[t]&&(r=parseInt(o[t],10)||1)}catch(o){console.warn("Failed to parse size count data:",o)}const a=document.querySelector("[data-pattern-product-count]");a&&(a.textContent=r)}}class k extends HTMLElement{constructor(){super(),this.checkboxes=new Map,this.patternProductCheckbox=null}connectedCallback(){this.init()}disconnectedCallback(){this.removeEventListeners()}init(){this.patternProductCheckbox=this.querySelector("#pattern_product"),this.patternProductCheckbox&&(this.setupPatternProductCheckbox(),this.updateInitialCount()),this.setupGenericCheckboxListeners(),this.setupFormSubmit()}setupFormSubmit(){const e=this.closest("form")||document.querySelector('form[action*="/cart/add"]');e&&(this.form=e,this.boundHandleFormSubmit=this.handleFormSubmit.bind(this),e.addEventListener("submit",this.boundHandleFormSubmit,!0))}handleFormSubmit(e){var P,v,w,g;if(!this.patternProductCheckbox||!this.patternProductCheckbox.checked)return;e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.target,n=t.querySelector('[type="submit"]');n&&(n.disabled=!0,n.classList.add("loading"));const r=t.querySelector('input[name="section-id"]'),a=r?r.value:null,o=t.querySelector('input[name="id"]'),i=t.querySelector('input[name="quantity"]');if(!o){console.error("Variant ID not found"),this.enableSubmitButton(n);return}const s=parseInt(o.value,10),u=i&&parseInt(i.value,10)||1,d=[{id:s,quantity:u}];if(this.patternProductCheckbox&&this.patternProductCheckbox.checked){const c=this.patternProductCheckbox.dataset.patternProductVariantId,h=this.patternProductCheckbox.dataset.currentVariantTitle||"",S=this.patternProductCheckbox.dataset.parrentProductCountForVariant||"{}";let m=1;try{const p=JSON.parse(S);p&&h&&p[h]&&(m=parseInt(p[h],10)||1)}catch(p){console.warn("Failed to parse size count data:",p)}if(c){const p=parseInt(c,10);if(isNaN(p)){console.error("Invalid pattern product variant ID:",c),this.enableSubmitButton(n),this.handleAddToCartError(new Error("Pattern product variant not available. Please try again."));return}d.push({id:p,quantity:m})}else{console.error("Pattern product variant ID not found"),this.enableSubmitButton(n),this.handleAddToCartError(new Error("Pattern product variant not available. Please try again."));return}}if(!d||d.length===0){console.error("No items to add to cart"),this.enableSubmitButton(n);return}const C=d.filter(c=>!c.id||isNaN(c.id)||c.quantity<=0);if(C.length>0){console.error("Invalid items:",C),this.enableSubmitButton(n);return}const b={items:d};a?b.sections_url=`/cart?section_id=cart-drawer&section_id=${encodeURIComponent(a)}`:b.sections_url="/cart?section_id=cart-drawer";const l=((v=(P=window.theme)==null?void 0:P.routes)==null?void 0:v.root)||((g=(w=window.theme)==null?void 0:w.routes)==null?void 0:g.shop_url)||"/",T=`${l.endsWith("/")?l:`${l}/`}cart/add.js`;fetch(T,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(b)}).then(c=>c.json().then(h=>{if(!c.ok){const S=h.description||h.message||h.error||"Failed to add to cart",m=new Error(S);throw m.response=h,m.status=c.status,m}return h})).then(c=>{this.handleAddToCartSuccess(c,b)}).catch(c=>{console.error("Error adding to cart:",c),this.handleAddToCartError(c)}).finally(()=>{this.enableSubmitButton(n)})}handleAddToCartSuccess(e,t){const n=document.querySelector("cart-element");n&&typeof n.getCart=="function"?n.getCart():(document.dispatchEvent(new CustomEvent("theme:cart:refresh",{bubbles:!0})),e.sections?this.updateCartSections(e.sections):t.sections_url&&this.fetchCartSections(t.sections_url)),document.dispatchEvent(new CustomEvent("theme:cart:add",{detail:{items:e.items||[],cart:e},bubbles:!0}))}handleAddToCartError(e){var n;const t=(n=this.form)==null?void 0:n.querySelector("[data-cart-errors-container]");t&&(t.textContent=e.message||"Failed to add product to cart",t.setAttribute("role","alert"),t.classList.remove("hidden")),document.dispatchEvent(new CustomEvent("theme:cart:add:error",{detail:{error:e},bubbles:!0}))}updateCartSections(e){if(e["cart-drawer"]){const t=document.querySelector("cart-drawer");t&&(t.innerHTML=e["cart-drawer"])}if(e["cart-icon-bubble"]){const t=document.querySelector("[data-cart-icon-bubble]");t&&(t.outerHTML=e["cart-icon-bubble"])}}fetchCartSections(e){fetch(e).then(t=>t.text()).then(t=>{const r=new DOMParser().parseFromString(t,"text/html"),a=r.querySelector("cart-drawer");if(a){const i=document.querySelector("cart-drawer");i&&(i.innerHTML=a.innerHTML)}const o=r.querySelector("[data-cart-icon-bubble]");if(o){const i=document.querySelector("[data-cart-icon-bubble]");i&&(i.outerHTML=o.outerHTML)}}).catch(t=>{console.error("Error fetching cart sections:",t)})}enableSubmitButton(e){e&&(e.disabled=!1,e.classList.remove("loading"))}updateInitialCount(){const e=this.patternProductCheckbox;if(!e)return;const t=e.dataset.currentVariantTitle||"",n=e.dataset.parrentProductCountForVariant||"{}";let r=1;try{const o=JSON.parse(n);o&&t&&o[t]&&(r=parseInt(o[t],10)||1)}catch(o){console.warn("Failed to parse size count data:",o)}const a=this.querySelector("[data-pattern-product-count]");a&&(a.textContent=r)}setupPatternProductCheckbox(){this.patternProductCheckbox.addEventListener("change",e=>{this.handlePatternProductChange(e)}),this.checkboxes.set("pattern_product",this.patternProductCheckbox)}handlePatternProductChange(e){const t=e.target,n=t.checked,r=parseFloat(t.dataset.mainProductPrice||0),a=parseFloat(t.dataset.patternProductPrice||0),o=t.dataset.patternProductId,i=t.dataset.patternProductFormattedPrice||"",s=t.dataset.currentVariantTitle||"",u=t.dataset.parrentProductCountForVariant||"{}";let d=1;try{const l=JSON.parse(u);l&&s&&l[s]&&(d=parseInt(l[s],10)||1)}catch(l){console.warn("Failed to parse size count data:",l)}const C=a*d,b=n?r+C:r;this.dispatchPatternProductChangeEvent({isChecked:n,mainProductPrice:r,patternProductPrice:C,patternProductPriceBase:a,countMultiplier:d,totalPrice:b,patternProductId:o,formattedPrice:i,currentVariantTitle:s}),this.updatePriceDisplay(b,n,i),this.updateFormData(n,o)}dispatchPatternProductChangeEvent(e){const t=new CustomEvent("product:pattern:change",{detail:e,bubbles:!0,cancelable:!0});this.dispatchEvent(t),document.dispatchEvent(t)}updatePriceDisplay(e,t,n){const r=document.querySelectorAll("[data-add-to-cart] [data-product-price]");if(r.length>0){const a=this.formatPrice(e);r.forEach(o=>{const i=o.querySelector(".price__regular, .price__current, [data-price]");i?i.textContent=a:o.textContent&&(o.textContent=a),t?o.classList.add("price--with-pattern-product"):o.classList.remove("price--with-pattern-product")})}}formatPrice(e){var t;if(window.theme&&window.theme.formatMoney)return window.theme.formatMoney(e,(t=window.theme)==null?void 0:t.moneyFormat)}updateFormData(e,t){const n=this.closest("form")||document.querySelector('form[action*="/cart/add"]');if(!n)return;let r=n.querySelector('[name="pattern_product_id"]');e&&t?(r||(r=document.createElement("input"),r.type="hidden",r.name="pattern_product_id",n.appendChild(r)),r.value=t):r&&r.remove()}setupGenericCheckboxListeners(){this.querySelectorAll('input[type="checkbox"]').forEach(t=>{if(t.id==="pattern_product")return;t.addEventListener("change",r=>{this.handleGenericCheckboxChange(r)});const n=t.name||t.id||`checkbox-${this.checkboxes.size}`;this.checkboxes.set(n,t)})}handleGenericCheckboxChange(e){const t=e.target,n=t.checked,r=t.name||t.id,a=new CustomEvent("product:checkbox:change",{detail:{name:r,isChecked:n,value:t.value,checkbox:t},bubbles:!0,cancelable:!0});this.dispatchEvent(a),document.dispatchEvent(a)}removeEventListeners(){this.form&&this.boundHandleFormSubmit&&this.form.removeEventListener("submit",this.boundHandleFormSubmit),this.checkboxes.forEach(e=>{var n;const t=e.cloneNode(!0);(n=e.parentNode)==null||n.replaceChild(t,e)}),this.checkboxes.clear(),this.patternProductCheckbox=null,this.form=null,this.boundHandleFormSubmit=null}getCheckboxState(e){const t=this.checkboxes.get(e)||this.querySelector(`#${e}, [name="${e}"]`);return t?t.checked:null}setCheckboxState(e,t){const n=this.checkboxes.get(e)||this.querySelector(`#${e}, [name="${e}"]`);n&&(n.checked=t,n.dispatchEvent(new Event("change",{bubbles:!0})))}}customElements.get("product-form-checkboxes")||customElements.define("product-form-checkboxes",k);customElements.get("variant-change-listener")||customElements.define("variant-change-listener",E);function y(){const f=setInterval(()=>{const e=customElements.get("variant-selects");if(e){clearInterval(f);const t=e.prototype.connectedCallback,n=e.prototype.disconnectedCallback;e.prototype.connectedCallback=function(){t&&t.call(this),this.setupVariantTitleUpdate()},e.prototype.disconnectedCallback=function(){this.variantTitleUpdateUnsubscriber&&(this.variantTitleUpdateUnsubscriber(),this.variantTitleUpdateUnsubscriber=null),this.optionChangeUnsubscriber&&(this.optionChangeUnsubscriber(),this.optionChangeUnsubscriber=null),n&&n.call(this)},e.prototype.setupVariantTitleUpdate=function(){var r,a;(a=(r=window.theme)==null?void 0:r.PUB_SUB_EVENTS)!=null&&a.optionValueSelectionChange&&window.subscribe&&(this.optionChangeUnsubscriber=window.subscribe(window.theme.PUB_SUB_EVENTS.optionValueSelectionChange,()=>{setTimeout(()=>this.updateVariantTitle(),200)})),setTimeout(()=>this.updateVariantTitle(),100)},e.prototype.updateVariantTitle=function(){const r=this.querySelector("[data-selected-variant]");if(r)try{const a=JSON.parse(r.textContent);if(a&&a.title){const o=a.title||"",i=document.querySelector("#pattern_product");i&&(i.setAttribute("data-current-variant-title",o),this.updatePatternProductCount(i),i.checked&&i.dispatchEvent(new Event("change",{bubbles:!0})))}}catch(a){console.warn("Failed to parse variant data:",a)}},e.prototype.updatePatternProductCount=function(r){const a=r.dataset.currentVariantTitle||"",o=r.dataset.parrentProductCountForVariant||"{}";let i=1;try{const u=JSON.parse(o);u&&a&&u[a]&&(i=parseInt(u[a],10)||1)}catch(u){console.warn("Failed to parse size count data:",u)}const s=document.querySelector("[data-pattern-product-count]");s&&(s.textContent=i)}}},100);setTimeout(()=>clearInterval(f),5e3)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",y):y();typeof window<"u"&&(window.PatternProductForm=k,window.VariantChangeListener=E);
